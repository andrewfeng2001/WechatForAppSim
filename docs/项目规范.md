# 项目整体的架构

```
WechatForAppSim/
├── app/
│   ├── build.gradle.kts                    # 应用模块构建配置
│   ├── proguard-rules.pro                  # ProGuard混淆规则
│   ├── src/
│   │   ├── androidTest/                    # Android集成测试
│   │   │   └── java/com/example/wechat_sim/
│   │   │       └── ExampleInstrumentedTest.kt
│   │   ├── test/                          # 单元测试
│   │   │   └── java/com/example/wechat_sim/
│   │   │       └── ExampleUnitTest.kt
│   │   └── main/
│   │       ├── AndroidManifest.xml        # Android清单文件
│   │       ├── assets/                    # 静态资源文件 ⭐
│   │       │   ├── avatar/               # 头像资源 (56个文件)
│   │       │   │   ├── me.jpg            # 当前用户头像
│   │       │   │   ├── friend_1.png      # 好友头像 (friend_1-21.png)
│   │       │   │   ├── nonfriend_1.jpg   # 非好友头像 (nonfriend_1-9.jpg)
│   │       │   │   ├── group_1.jpg       # 群聊头像 (group_1-4.jpg)
│   │       │   │   └── 00_default_avatar.jpg
│   │       │   ├── data/                 # JSON数据文件 (6个文件)
│   │       │   │   ├── app_config.json   # 应用配置
│   │       │   │   ├── contacts.json     # 联系人数据 (51个联系人)
│   │       │   │   ├── chatrooms.json    # 群聊数据 (4个群)
│   │       │   │   ├── messages.json     # 消息数据
│   │       │   │   └── moments.json      # 朋友圈动态数据
│   │       │   └── image/                # 消息和朋友圈图片 (24个文件)
│   │       │       ├── moment_1.jpg      # 朋友圈配图
│   │       │       └── message_img_1.jpg # 消息图片
│   │       ├── java/com/example/wechat_sim/
│   │       │   ├── MainActivity.kt       # 应用入口Activity
│   │       │   ├── common/               # 通用模块 ⭐
│   │       │   │   ├── constants/        # 常量定义
│   │       │   │   │   └── AppConstants.kt
│   │       │   │   ├── extension/        # Kotlin扩展函数
│   │       │   │   │   └── StringExtensions.kt
│   │       │   │   └── utils/            # 工具类
│   │       │   │       └── MessageChecker.kt
│   │       │   ├── data/                 # 数据层 (MVP Model层) ⭐
│   │       │   │   ├── model/            # 数据模型 (10个文件)
│   │       │   │   │   ├── Contact.kt    # 联系人模型
│   │       │   │   │   ├── Message.kt    # 消息模型 (支持8种消息类型)
│   │       │   │   │   ├── ChatRoom.kt   # 群聊模型
│   │       │   │   │   ├── MomentsPost.kt# 朋友圈动态模型
│   │       │   │   │   ├── Comment.kt    # 评论模型
│   │       │   │   │   ├── AppConfig.kt  # 应用配置模型
│   │       │   │   │   ├── MessagesData.kt # 消息容器模型
│   │       │   │   │   ├── MomentsData.kt  # 朋友圈容器模型
│   │       │   │   │   ├── MessageType.kt  # 消息类型枚举
│   │       │   │   │   └── ChatListItem.kt # 聊天列表项模型
│   │       │   │   └── repository/       # 数据仓库层
│   │       │   │       └── DataRepository.kt # 核心数据仓库
│   │       │   ├── presentation/         # MVP表现层 (8个模块) ⭐
│   │       │   │   ├── BaseContract.kt   # MVP基础契约接口
│   │       │   │   ├── main/             # 主界面模块
│   │       │   │   │   ├── MainContract.kt
│   │       │   │   │   └── MainPresenter.kt
│   │       │   │   ├── chat/             # 聊天列表模块
│   │       │   │   │   ├── ChatContract.kt
│   │       │   │   │   ├── ChatPresenter.kt
│   │       │   │   │   └── ChatScreen.kt
│   │       │   │   ├── chatdetails/      # 聊天详情模块
│   │       │   │   │   ├── ChatDetailsContract.kt
│   │       │   │   │   ├── ChatDetailsPresenter.kt (216行)
│   │       │   │   │   ├── ChatDetailsScreen.kt (431行)
│   │       │   │   │   └── components/
│   │       │   │   │       └── ChatMessageItem.kt
│   │       │   │   ├── contact/          # 通讯录模块
│   │       │   │   │   ├── ContactContract.kt
│   │       │   │   │   ├── ContactPresenter.kt
│   │       │   │   │   ├── ContactScreen.kt
│   │       │   │   │   └── components/   # 通讯录组件
│   │       │   │   │       ├── AlphabetNavigator.kt
│   │       │   │   │       ├── ContactPinyinUtils.kt
│   │       │   │   │       ├── FriendItemRow.kt
│   │       │   │   │       └── ContactFunctionSection.kt
│   │       │   │   ├── contactdetails/   # 联系人详情模块
│   │       │   │   │   ├── ContactDetailsContract.kt
│   │       │   │   │   ├── ContactDetailsPresenter.kt
│   │       │   │   │   └── ContactDetailsScreen.kt
│   │       │   │   ├── discover/         # 发现页面模块
│   │       │   │   │   ├── DiscoverContract.kt
│   │       │   │   │   ├── DiscoverPresenter.kt
│   │       │   │   │   └── DiscoverScreen.kt
│   │       │   │   ├── moments/          # 朋友圈模块
│   │       │   │   │   ├── MomentsContract.kt
│   │       │   │   │   ├── MomentsPresenter.kt
│   │       │   │   │   ├── MomentsScreen.kt
│   │       │   │   │   └── components/
│   │       │   │   │       ├── MomentsPostItem.kt
│   │       │   │   │       └── MomentsHeader.kt
│   │       │   │   ├── me/               # 个人中心模块
│   │       │   │   │   ├── MeContract.kt
│   │       │   │   │   ├── MePresenter.kt
│   │       │   │   │   ├── MeScreen.kt
│   │       │   │   │   └── components/
│   │       │   │   │       ├── ProfileCard.kt
│   │       │   │   │       └── MeMenuSection.kt
│   │       │   │   └── search/           # 搜索模块
│   │       │   │       ├── SearchContract.kt
│   │       │   │       ├── SearchPresenter.kt
│   │       │   │       ├── SearchScreen.kt
│   │       │   │       └── components/
│   │       │   │           └── SearchResultItem.kt
│   │       │   ├── navigation/           # 导航管理
│   │       │   │   └── Routes.kt         # 路由定义 (4个路由)
│   │       │   ├── network/              # 网络层 (预留，未实现)
│   │       │   └── ui/                   # UI通用组件层 ⭐
│   │       │       ├── components/       # 通用Compose组件 (5个文件)
│   │       │       │   ├── AvatarImage.kt      # 头像加载组件
│   │       │       │   ├── CustomCard.kt       # 自定义卡片组件
│   │       │       │   ├── LoadingIndicator.kt # 加载指示器
│   │       │       │   ├── ErrorView.kt        # 错误提示组件
│   │       │       │   └── EmptyView.kt        # 空状态组件
│   │       │       └── theme/            # 主题配置
│   │       │           ├── Theme.kt      # Material3主题
│   │       │           ├── Color.kt      # 颜色定义
│   │       │           └── Type.kt       # 字体定义
│   │       └── res/                      # Android资源文件
│   │           ├── drawable/             # 图标和矢量资源
│   │           ├── values/               # 值资源
│   │           │   ├── strings.xml       # 字符串资源
│   │           │   ├── colors.xml        # 颜色资源
│   │           │   └── themes.xml        # 主题配置
│   │           └── xml/                  # XML配置文件
│   │               ├── data_extraction_rules.xml
│   │               └── backup_rules.xml
├── gradle/                               # Gradle配置
│   └── wrapper/                          # Gradle Wrapper
│       ├── gradle-wrapper.jar
│       └── gradle-wrapper.properties
├── build.gradle.kts                      # 项目根构建文件
├── settings.gradle.kts                   # 项目设置 (配置Aliyun镜像)
├── gradle.properties                     # Gradle属性配置
├── libs.versions.toml                    # 版本目录 (Version Catalog)
└── local.properties                      # 本地属性配置
```

## 1) 数据文件如何保存

首先，包含两层数据，静态数据保存在Asset中，动态数据（例如Message、Moments）存在json中，支持增删改查

### 数据存储架构
```
├── 第一层: Assets静态资源 (只读)
│   ├── 应用初始数据
│   ├── 演示用户和群聊信息
│   └── 内置聊天记录和朋友圈内容
└── 第二层: 内部存储文件 (可读写)
    ├── 用户新发送的消息
    ├── 朋友圈点赞和评论数据
    └── 其他用户操作产生的数据
```

### 动态数据存储 (内部存储)

存储位置可以参考`DataRepository.kt`

```kotlin
// DataRepository.kt
private fun saveMessagesToFile(messagesData: MessagesData) {
    val jsonString = gson.toJson(messagesData)
    val file = java.io.File(context.filesDir, "messages.json") // 内部存储
    file.writeText(jsonString)
}

private fun saveMomentsToFile(momentsData: MomentsData) {
    val jsonString = gson.toJson(momentsData)
    val file = java.io.File(context.filesDir, "moments.json") // 内部存储
    file.writeText(jsonString)
}
```

### 数据读取优先级策略

```kotlin
// DataRepository.kt 第71-76行
suspend fun getMessagesFromStorage(): MessagesData {
    return try {
        // 1. 优先从内部存储读取 (包含用户新数据)
        repository.getMessagesFromStorage()
    } catch (e: Exception) {
        // 2. 回退到Assets静态数据
        repository.getMessages()
    }
}
```

### 数据变化流程

以消息发送为例，其流程如下:

```
用户发送消息 → 创建Message对象 → 添加到现有消息列表 → 保存到内部存储
```

1. **触发**: 用户在聊天界面输入并发送消息
2. **处理流程**:
   ```
   ChatDetailsPresenter.onSendMessage()
   ↓
   创建Message对象(包含时间戳、消息ID等)
   ↓
   DataRepository.saveMessage()
   ↓
   读取现有messages.json → 添加新消息 → 写回文件
   ```
3. **结果**: 消息立即显示在UI，重启应用后仍然保留

### 负责数据保存的核心类: DataRepository

```kotlin
class DataRepository(private val context: Context) {
    private val gson: Gson = GsonBuilder()
        .registerTypeAdapter(LocalDateTime::class.java, LocalDateTimeDeserializer())
        .setPrettyPrinting()
        .create()

    private var appConfig: AppConfig? = null // 内存缓存

    // 主要职责:
    // 1. 资源加载 - 从assets JSON加载初始数据
    // 2. 内存缓存 - 将AppConfig缓存到内存
    // 3. 数据查询 - 提供各类型数据的查询接口
    // 4. 文件持久化 - 支持消息和朋友圈数据的修改和保存
}
```

## 2) Model读取进来之后是什么样的数据类型

### 一、核心数据模型层 (data/model/)

以Contact (联系人模型)为例

**位置**：`app/src/main/java/com/example/wechat_sim/data/model/Contact.kt`

```kotlin
data class Contact(
    val userId: String,                // 用户ID (eg. "user_1")
    val userName: String,              // 用户名 (eg. "王晨曦")
    val remarkName: String? = null,    // 备注名 (eg. "大学室友")
    val wxId: String? = null,          // 微信号 (eg. "wangchenxi_2024")
    val region: String? = null,        // 地区 (eg. "北京 朝阳")
    val avatarUrl: String? = null,     // 头像路径 (eg. "avatar/friend_1.jpg")
    val signature: String? = null,     // 个性签名 (eg. "生活不止眼前的苟且")
    val isFriend: Boolean = true       // 好友关系 (eg. true)
)
```

- **数据来源**：contacts.json -> friends数组/nonFriends数组
- **实例数量**：51个对象 (42个好友 + 9个非好友)

其他数据类型均保存在`app/src/main/java/com/example/wechat_sim/data/model`中

### 二、JSON映射模型层

#### 1. MessagesData (消息容器模型)

**位置**：`app/src/main/java/com/example/wechat_sim/data/model/MessagesData.kt`

```kotlin
data class MessagesData(
    val privateChatMessages: Map<String, List<JsonMessage>>,  // 私聊消息Map
    val groupChatMessages: Map<String, List<JsonMessage>>     // 群聊消息Map
)
```

**数据结构**：
- **Key**: 用户ID或群聊ID (String)
- **Value**: 该聊天的消息列表 (List<JsonMessage>)

#### 2. JsonMessage (JSON消息映射模型)

**位置**：`app/src/main/java/com/example/wechat_sim/data/model/MessagesData.kt`

```kotlin
data class JsonMessage(
    val id: String,
    val senderId: String,
    val receiverId: String?,
    val chatRoomId: String?,
    val content: String,
    val type: String,                  // 注意：这里是String类型，不是enum
    val timestamp: String,             // 注意：这里是String类型，不是LocalDateTime
    val isFromSelf: Boolean,
    val mediaPath: String?
)
```

#### 3. AppConfig (应用配置容器)

**位置**：`app/src/main/java/com/example/wechat_sim/data/model/AppConfig.kt`

```kotlin
data class AppConfig(
    val currentUserId: String,              // 当前用户ID (eg. "current_user")
    val contacts: List<Contact>,            // 联系人对象列表
    val chatRooms: List<ChatRoom>,          // 群聊对象列表
    val momentsData: MomentsData,           // 朋友圈数据容器
    val messages: List<Message> = emptyList() // 消息对象列表（默认空）
)

data class MomentsData(
    val posts: List<MomentsPost>           // 朋友圈动态对象列表
)
```

### 三、UI展示模型层 (presentation层)

#### 1. ChatListItem (聊天列表项模型)

**位置**：`app/src/main/java/com/example/wechat_sim/presentation/chat/ChatContract.kt`

```kotlin
data class ChatListItem(
    val chatId: String,                    // 聊天ID
    val title: String,                     // 显示标题
    val avatarUrl: String?,                // 头像URL
    val lastMessage: String?,              // 最后一条消息
    val lastMessageTime: String?,          // 最后消息时间（格式化字符串）
    val unreadCount: Int = 0,              // 未读数量
    val isGroup: Boolean = false           // 是否群聊
)
```

**用途**：聊天列表界面显示，包含格式化的展示数据

#### 2. ChatMessageItem (聊天消息项模型)

**位置**：`app/src/main/java/com/example/wechat_sim/presentation/chatdetails/ChatDetailsContract.kt`

```kotlin
data class ChatMessageItem(
    val messageId: String,                 // 消息ID
    val senderId: String,                  // 发送者ID
    val senderName: String,                // 发送者显示名称（处理过的）
    val senderAvatarUrl: String?,          // 发送者头像
    val content: String,                   // 消息内容
    val type: String,                      // 消息类型（String形式）
    val timestamp: String,                 // 原始时间戳字符串
    val isFromSelf: Boolean,               // 是否自己发送
    val mediaPath: String?,                // 媒体路径
    val formattedTime: String              // 格式化时间（如"10:30"）
)
```

**特点**：包含UI展示需要的格式化数据，如senderName（备注名优先）、formattedTime等

### 四、数据类型转换流程

#### 数据模型转换链
```
JSON文件 -> JsonMessage -> Message -> ChatMessageItem
    |           |           |           |
  String     String     LocalDateTime   String
  类型       类型        对象类型       格式化类型
```

### 五、内存中的数据结构

#### 1. DataRepository中的缓存
```kotlin
private var appConfig: AppConfig? = null  // 应用配置单例缓存
```

**数据读取顺序**：
```
内存缓存 -> 内部存储文件 -> Assets静态文件
```

#### 2. Presenter中的状态管理
```kotlin
var messages by remember { mutableStateOf<List<ChatMessageItem>>(emptyList()) }
var contacts by remember { mutableStateOf<List<Contact>>(emptyList()) }
```

#### 3. 集合类型分析
```kotlin
List<Contact>        -> 不可变列表，只读联系人数据
MutableList<String>  -> 可变列表，支持运行时添加删除（如点赞列表）
Map<String, List<JsonMessage>> -> 映射表，按聊天ID组织消息
```

## 3) MVP中的V和P，在执行动作的时候，页面和数据如何变化

项目采用MVP架构，View(V)负责UI展示和用户交互，Presenter(P)负责业务逻辑处理和数据管理。当用户在页面上执行操作时，会触发V→P→V的完整数据流循环，实现页面状态的响应式更新。

### 一、核心交互流程
```
用户操作 → View回调 → Presenter处理 → Model数据变更 → View状态更新 → UI重新渲染
```

### 具体场景分析: 以发送聊天消息为例

#### 1. 用户操作触发
```kotlin
// ChatDetailsScreen.kt: L418-429
IconButton(
    onClick = {
        onSendMessage(inputText)  // V层回调
    },
    enabled = inputText.isNotBlank()
)
```

**页面状态**：用户点击发送按钮，触发onClick回调

#### 2. View层回调处理
```kotlin
// ChatDetailsScreen.kt: L225-229
onSendMessage = { content ->
    if (content.isNotBlank()) {  // V层简单验证
        presenter.onSendMessage(content)  // 调用P层方法
    }
}
```

**数据变化**：
- **输入验证**：V层检查content是否为空
- **调用转发**：将用户输入传递给Presenter

#### 3. Presenter层业务逻辑处理
```kotlin
// ChatDetailsPresenter.kt: L142-191
override fun onSendMessage(content: String) {
    if (content.isNotBlank() && currentChatId != null) {
        presenterScope.launch {
            try {
                val currentUser = repository.getCurrentUser()
                val currentTime = LocalDateTime.now()
                val messageId = "msg_${System.currentTimeMillis()}"

                // 创建UI显示用的消息项
                val newChatMessageItem = ChatMessageItem(...)

                // 创建持久化用的消息对象
                val messageForStorage = Message(...)

                // 保存到文件系统
                withContext(Dispatchers.IO) {
                    repository.saveMessage(messageForStorage, currentIsGroup)
                }

                // 通知View更新UI
                view?.addNewMessage(newChatMessageItem)
                view?.clearInputText()
                view?.scrollToBottom()

            } catch (e: Exception) {
                view?.showError("发送消息失败: ${e.message}")
            }
        }
    }
}
```

**数据变化**：
1. **数据创建**：
   - 生成唯一messageId：`"msg_${System.currentTimeMillis()}"`
   - 创建ChatMessageItem（UI用）
   - 创建Message对象（持久化用）

2. **数据持久化**：
   - 调用`repository.saveMessage()`保存到JSON文件
   - 在IO调度器中执行，避免阻塞UI

3. **状态通知**：
   - `view?.addNewMessage()` - 添加消息到列表
   - `view?.clearInputText()` - 清空输入框
   - `view?.scrollToBottom()` - 滚动到底部

#### 4. View层状态更新
```kotlin
// ChatDetailsScreen.kt: L98-100
override fun addNewMessage(message: ChatMessageItem) {
    messages = messages + message  // 更新Compose状态
}

// ChatDetailsScreen.kt: L94-96
override fun clearInputText() {
    inputText = ""  // 清空输入框状态
}
```

**页面变化**：
1. **消息列表更新**：`messages`状态变量增加新消息
2. **输入框清空**：`inputText`状态变量重置为空字符串
3. **滚动位置**：自动滚动到列表底部

#### 5. Compose UI重新渲染
```kotlin
// ChatDetailsScreen.kt: L248-254
items(messages) { message ->
    MessageBubble(
        message = message,
        onAvatarClick = onAvatarClick
    )
}
```

**最终效果**：
- 新消息立即出现在聊天界面
- 发送按钮状态从enabled变为disabled（因为输入框为空）
- 列表自动滚动显示最新消息
- 消息持久化保存，重启应用后仍然存在

### 三、数据流动的完整时序图

#### 1. 发送消息场景时序
```
用户 → View → Presenter → Repository → File System
 |      |        |           |           |
 |      |        |           |           |- 保存message.json
 |      |        |           |- saveMessage()
 |      |        |- onSendMessage()
 |      |- onClick callback
 |- 点击发送按钮

File System → Repository → Presenter → View → UI
     |           |           |          |      |
     |           |           |          |      |- 消息显示
     |           |           |          |- addNewMessage()
     |           |           |- view?.callback()
     |           |- 数据已保存
     |- 持久化完成
```

#### 2. 页面状态变化时间线
```
T0: 用户输入消息 "你好"
    - inputText = "你好"
    - sendButton.enabled = true

T1: 用户点击发送 (点击事件)
    - onClick触发
    - presenter.onSendMessage("你好")

T2: Presenter开始处理 (+10ms)
    - 创建Message对象
    - 调用repository.saveMessage()

T3: 数据保存完成 (+100ms)
    - JSON文件写入完成
    - 创建ChatMessageItem

T4: View状态更新 (+110ms)
    - messages = messages + newMessage
    - inputText = ""
    - scrollToBottom()

T5: UI重新渲染 (+120ms)
    - 新消息显示在列表中
    - 输入框清空
    - 自动滚动到底部
```
